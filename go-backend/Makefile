.PHONY: build migrate seed run test setup clean dev install-air help

# =========================
# âš™ï¸ Default Configuration
# =========================
DB_HOST ?= localhost
DB_PORT ?= 3306
DB_USER ?= root
DB_PASS ?= @Joseph13101
DB_NAME ?= virtual_lab

# =========================
# ğŸ—ï¸ Build Targets
# =========================
build:
	@echo "ğŸ”§ Building application..."
	go build -o bin/server ./cmd/server
	go build -o bin/migrate ./cmd/migrate
	@echo "âœ… Build completed."

# =========================
# ğŸ—„ï¸ Database Migrations
# =========================
migrate: build
	@echo "ğŸ“¦ Running database migrations..."
	./bin/migrate
	@echo "âœ… Migrations applied successfully."

# =========================
# ğŸŒ± Seed Database
# =========================
seed:
	@echo "ğŸŒ± Seeding database..."
	mysql -h$(DB_HOST) -P$(DB_PORT) -u$(DB_USER) -p$(DB_PASS) $(DB_NAME) < scripts/seed.sql
	@echo "âœ… Database seeded successfully."

# =========================
# ğŸš€ Run Application
# =========================
run: build
	@echo "ğŸš€ Starting Virtual Lab API..."
	./bin/server

# =========================
# ğŸ§ª Test Backend
# =========================
test:
	@echo "ğŸ§ª Running backend tests..."
	go run scripts/test_backend.go

# =========================
# âš¡ Setup: Migrate + Seed
# =========================
setup: migrate seed
	@echo "âœ… Environment setup completed."

# =========================
# ğŸ§¹ Clean Build Artifacts
# =========================
clean:
	@echo "ğŸ§¹ Cleaning up build artifacts..."
	@if exist bin (rmdir /S /Q bin) || true
	@if exist tmp (rmdir /S /Q tmp) || true
	@echo "âœ… Cleanup done."

# =========================
# ğŸ”¥ Development Mode (Air)
# =========================
dev:
	@echo "ğŸ”¥ Starting development server (Air hot reload)..."
	air

# =========================
# ğŸ› ï¸ Install Air (One-time)
# =========================
install-air:
	@echo "â¬‡ï¸ Installing Air hot reload tool..."
	go install github.com/air-verse/air@latest
	@echo "âœ… Air installed successfully."

# =========================
# ğŸ§­ Help Menu
# =========================
help:
	@echo ""
	@echo "ğŸ§­ Available Make Commands:"
	@echo "  make build        â†’ Build the application binaries"
	@echo "  make migrate      â†’ Run database migrations"
	@echo "  make seed         â†’ Seed database with sample data"
	@echo "  make run          â†’ Run the backend server"
	@echo "  make dev          â†’ Start dev mode with Air hot reload"
	@echo "  make setup        â†’ Migrate + seed database"
	@echo "  make clean        â†’ Remove build artifacts"
	@echo "  make test         â†’ Run backend test script"
	@echo "  make install-air  â†’ Install Air tool for hot reload"
	@echo ""
